import React, { useState } from 'react';
import { Button } from '../atoms';
import { InputField } from '../molecules';
// Importe seus tipos aqui. Exemplo simulado:
// import type { CalculationInput, CalculationResponse } from '../../../types';

// Mock de tipos para compilação deste exemplo
type CalculationInput = any;
type CalculationResponse = any;

interface CalculatorFormProps {
  onCalculate: (result: CalculationResponse, input: CalculationInput) => void;
  onError: (message: string) => void;
  onLoadingChange: (loading: boolean) => void;
}

const DEFAULT_VALUES = {
  carValue: 50000,
  monthlyRent: 2200,
  interestRateMonth: 1.5,
  financingTermMonths: 48,
  analysisPeriodMonths: 48,
  downPaymentPercent: 25,
  maintenanceAnnual: 2000,
  insuranceRateAnnual: 6,
  ipvaRate: 4,
};

export function CalculatorForm({ onCalculate, onError, onLoadingChange }: CalculatorFormProps) {
  // Estado local simplificado para estilização
  const [formData, setFormData] = useState(DEFAULT_VALUES);
  const [advancedOpen, setAdvancedOpen] = useState(false);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    onLoadingChange(true);
    
    // Simulação de delay de rede
    setTimeout(() => {
      setLoading(false);
      onLoadingChange(false);
      // Aqui você chamaria sua lógica real de cálculo
      onCalculate({}, formData); 
    }, 1500);
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-8">
      {/* SEÇÃO: Dados Básicos */}
      <section>
        <div className="flex items-center gap-3 mb-6">
          <div className="h-8 w-1 bg-sage-400 rounded-full"></div>
          <h2 className="text-h2 !text-xl md:!text-2xl">Dados Básicos</h2>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
          <InputField
            id="carValue"
            name="carValue"
            label="Valor do Carro (R$)"
            type="number"
            placeholder="Ex: 50000"
            value={formData.carValue}
            onChange={handleChange}
            className="md:col-span-2" // Full width no topo
          />
          
          <InputField
            id="monthlyRent"
            name="monthlyRent"
            label="Aluguel Mensal (R$)"
            type="number"
            value={formData.monthlyRent}
            onChange={handleChange}
            tooltip="Quanto custaria alugar um carro similar mensalmente?"
          />
          
          <InputField
            id="interestRateMonth"
            name="interestRateMonth"
            label="Taxa de Juros Mensal (%)"
            type="number"
            step="0.01"
            value={formData.interestRateMonth}
            onChange={handleChange}
          />
          
          <InputField
            id="financingTermMonths"
            name="financingTermMonths"
            label="Prazo Financiamento (Meses)"
            type="number"
            value={formData.financingTermMonths}
            onChange={handleChange}
          />
          
          <InputField
            id="analysisPeriodMonths"
            name="analysisPeriodMonths"
            label="Período de Análise (Meses)"
            type="number"
            value={formData.analysisPeriodMonths}
            onChange={handleChange}
            helperText="Tempo total que você pretende ficar com o carro."
          />
        </div>
      </section>

      {/* SEÇÃO: Avançado (Toggle) */}
      <section className="border-t border-olive-100 pt-6">
        <button
          type="button"
          onClick={() => setAdvancedOpen(!advancedOpen)}
          className="flex items-center gap-2 text-olive-600 font-medium hover:text-olive-900 transition-colors group w-full text-left"
        >
          <div className={`transform transition-transform duration-300 ${advancedOpen ? 'rotate-90' : 'rotate-0'}`}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5 text-sage-500">
              <path fillRule="evenodd" d="M16.28 11.47a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 01-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 011.06-1.06l7.5 7.5z" clipRule="evenodd" />
            </svg>
          </div>
          <span className="text-lg">Opções Avançadas</span>
          <span className="text-sm text-olive-400 font-normal ml-auto hidden sm:block">
            {advancedOpen ? 'Ocultar detalhes' : 'Ajustar entrada, manutenção, taxas...'}
          </span>
        </button>

        <div className={`grid transition-all duration-500 ease-in-out overflow-hidden ${advancedOpen ? 'grid-rows-[1fr] opacity-100 mt-6' : 'grid-rows-[0fr] opacity-0 mt-0'}`}>
          <div className="overflow-hidden">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6 pb-2">
              <InputField
                id="downPaymentPercent"
                name="downPaymentPercent"
                label="Entrada (%)"
                type="number"
                value={formData.downPaymentPercent}
                onChange={handleChange}
                tooltip="Porcentagem do valor do carro paga à vista."
              />
              
              <InputField
                id="maintenanceAnnual"
                name="maintenanceAnnual"
                label="Manutenção Anual (R$)"
                type="number"
                value={formData.maintenanceAnnual}
                onChange={handleChange}
              />
              
              <InputField
                id="insuranceRateAnnual"
                name="insuranceRateAnnual"
                label="Seguro Anual (%)"
                type="number"
                step="0.1"
                value={formData.insuranceRateAnnual}
                onChange={handleChange}
                helperText="Sobre o valor do carro."
              />
              
              <InputField
                id="ipvaRate"
                name="ipvaRate"
                label="Taxa IPVA (%)"
                type="number"
                step="0.1"
                value={formData.ipvaRate}
                onChange={handleChange}
              />
            </div>
          </div>
        </div>
      </section>

      {/* AÇÕES */}
      <div className="pt-4">
        <Button 
          type="submit" 
          variant="primary" 
          fullWidth 
          loading={loading}
          className="text-lg shadow-lg shadow-sage-400/20"
        >
          Calcular Comparação
        </Button>
      </div>
    </form>
  );
}