import React, { useState } from 'react';
import { Card } from '../atoms';
import { Icon } from '../atoms/Icon'; // Importando Icon
import { CostComparisonChart } from './CostComparisonChart';

// Mock types
type Props = {
  result: any;
  input: any;
  loading: boolean;
  error: string | null;
};

const formatCurrency = (val: number) => 
  new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

export function ComparisonResults({ result, input, loading, error }: Props) {
  const [expandedCards, setExpandedCards] = useState<Record<string, boolean>>({});

  const toggleCard = (id: string) => {
    setExpandedCards(prev => ({ ...prev, [id]: !prev[id] }));
  };

  // --- LOADING STATE COM SHIMMER ---
  if (loading) return <ResultsSkeleton />;
  
  // --- ERROR STATE ---
  if (error) {
    return (
      <div className="bg-red-50 border border-status-error/20 rounded-xl p-8 text-center text-status-error animate-slide-down">
        <div className="flex justify-center mb-3">
          <Icon name="error" size="lg" />
        </div>
        <p className="font-bold text-lg">Não foi possível calcular</p>
        <p className="text-sm mt-1 opacity-80">{error}</p>
      </div>
    );
  }

  // --- EMPTY STATE ---
  if (!result) {
    return (
      <div className="bg-white rounded-2xl border border-dashed border-olive-200 p-12 text-center animate-fadeIn">
        <div className="w-16 h-16 bg-sage-50 text-sage-400 rounded-full flex items-center justify-center mx-auto mb-4">
          <Icon name="info" size="xl" />
        </div>
        <h3 className="text-h3 text-olive-600">Aguardando Dados</h3>
        <p className="text-olive-400 mt-2 max-w-md mx-auto">
          Preencha o formulário acima e clique em "Calcular Comparação" para ver a análise financeira detalhada.
        </p>
      </div>
    );
  }

  // --- DATA PRESENT STATE ---
  const scenarios = [
    { id: 'cash', label: 'Compra à Vista', total: 83009.67, color: 'text-scenario-cash' },
    { id: 'financed', label: 'Financiado', total: 121082.42, color: 'text-scenario-financed' },
    { id: 'rental', label: 'Aluguel', total: 105600.00, color: 'text-scenario-rental' }
  ];
  
  const bestOptionId = scenarios.reduce((prev, curr) => prev.total < curr.total ? prev : curr).id;

  return (
    <div className="space-y-12 animate-slide-down">
      
      {/* 1. CARDS DE RESULTADO */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {scenarios.map((scenario) => {
          const isBest = scenario.id === bestOptionId;
          const isExpanded = !!expandedCards[scenario.id];

          return (
            <Card 
              key={scenario.id} 
              highlight={isBest ? 'success' : 'none'}
              className="flex flex-col h-full relative"
            >
              <div className="mb-4">
                <h3 className="text-sm font-semibold uppercase tracking-wider text-olive-500 mb-1 flex items-center gap-2">
                  {scenario.label}
                  {isBest && <Icon name="check" size="sm" className="text-sage-600" />}
                </h3>
                <p className={`text-3xl font-bold font-mono tracking-tight text-olive-900`}>
                  {formatCurrency(scenario.total)}
                </p>
                {/* Texto secundário condicional */}
                {scenario.id === 'financed' && (
                  <p className="text-sm text-olive-500 mt-1">Parcela: <span className="font-medium">R$ 1.101,56</span>/mês</p>
                )}
                {scenario.id === 'rental' && (
                   <p className="text-sm text-olive-500 mt-1">Mensalidade: <span className="font-medium">R$ 2.200,00</span></p>
                )}
              </div>

              <div className="mt-auto pt-4 border-t border-olive-50">
                <button 
                  onClick={() => toggleCard(scenario.id)}
                  className="flex items-center justify-between w-full text-sm font-medium text-sage-600 hover:text-sage-700 transition-colors py-1"
                >
                  {isExpanded ? 'Ocultar detalhes' : 'Detalhar custos'}
                  <span className={`transform transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                    <Icon name="chevron-down" size="sm" />
                  </span>
                </button>

                {/* Área Expansível */}
                <div className={`grid transition-all duration-300 ease-in-out overflow-hidden ${isExpanded ? 'grid-rows-[1fr] opacity-100 mt-4' : 'grid-rows-[0fr] opacity-0 mt-0'}`}>
                  <div className="overflow-hidden">
                    <ul className="space-y-2 text-sm text-olive-600 pb-2">
                      <li className="flex justify-between">
                        <span>Depreciação</span>
                        <span className="font-mono font-medium text-olive-800">R$ 23.990</span>
                      </li>
                      <li className="flex justify-between">
                        <span>IPVA Total</span>
                        <span className="font-mono font-medium text-olive-800">R$ 6.116</span>
                      </li>
                      <li className="flex justify-between">
                        <span>Seguro Total</span>
                        <span className="font-mono font-medium text-olive-800">R$ 9.174</span>
                      </li>
                      {scenario.id === 'financed' && (
                        <li className="flex justify-between text-status-warning/80">
                          <span>Juros Pagos</span>
                          <span className="font-mono font-medium">R$ 15.375</span>
                        </li>
                      )}
                    </ul>
                  </div>
                </div>
              </div>
            </Card>
          );
        })}
      </div>

      {/* 2. GRÁFICO */}
      <div className="bg-white rounded-2xl shadow-soft p-6 md:p-8">
        <div className="mb-6">
          <h3 className="text-h3">Evolução de Custos Acumulada</h3>
          <p className="text-body text-sm mt-1">Comparativo mês a mês ao longo de {input?.analysisPeriodMonths || 48} meses.</p>
        </div>
        <div className="h-[300px] md:h-[400px] w-full">
           <CostComparisonChart data={[]} showBreakEven={true} />
        </div>
      </div>

      {/* 3. PONTO DE EQUILÍBRIO */}
      <div className="bg-olive-900 rounded-2xl p-6 md:p-8 text-white relative overflow-hidden">
        <div className="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-sage-500 rounded-full blur-3xl opacity-20"></div>
        
        <div className="flex items-start gap-4 relative z-10">
          <div className="bg-white/10 p-3 rounded-lg text-sage-300 hidden sm:block">
            <Icon name="info" size="md" />
          </div>
          <div>
            <h3 className="text-xl font-semibold mb-3 text-sage-50">Análise de Ponto de Equilíbrio</h3>
            <ul className="space-y-3">
              <li className="flex items-center gap-2 text-olive-100">
                <span className="w-1.5 h-1.5 bg-sage-400 rounded-full"></span>
                <p>Aluguel vs Compra à Vista: <span className="text-white font-bold">Empata no mês 29</span></p>
              </li>
              <li className="flex items-center gap-2 text-olive-100">
                <span className="w-1.5 h-1.5 bg-sage-400 rounded-full"></span>
                <p>Aluguel vs Financiado: <span className="text-white font-bold">Nunca empata</span> (Aluguel é sempre melhor)</p>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

// Skeleton com Shimmer Effect
function ResultsSkeleton() {
  // Classe base para o efeito shimmer (background gradient + animation)
  const shimmerClass = "relative overflow-hidden bg-olive-100 before:absolute before:inset-0 before:-translate-x-full before:animate-shimmer before:bg-gradient-to-r before:from-transparent before:via-white/60 before:to-transparent";

  return (
    <div className="space-y-12">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {[1, 2, 3].map(i => (
          <div key={i} className={`h-64 rounded-2xl border border-white/20 shadow-sm ${shimmerClass}`}></div>
        ))}
      </div>
      <div className={`w-full h-96 rounded-2xl shadow-sm ${shimmerClass}`}></div>
      <div className={`w-full h-40 rounded-2xl shadow-sm bg-olive-900/10 ${shimmerClass}`}></div>
    </div>
  );
}